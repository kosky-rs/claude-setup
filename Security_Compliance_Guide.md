# セキュリティ・コンプライアンス設定ガイド

Claude Codeのセキュリティ制御に関する設定と取り組みをまとめた文書です。
チームでの議論・カスタマイズの叩き台としてご利用ください。

---

## 目次

1. [設計思想](#1-設計思想)
2. [パーミッション制御](#2-パーミッション制御)
3. [監査ログ](#3-監査ログ)
4. [セキュリティレビューコマンド](#4-セキュリティレビューコマンド)
5. [今後の拡張案](#5-今後の拡張案)
6. [議論ポイント](#6-議論ポイント)

---

## 1. 設計思想

### 多層防御アプローチ

```
┌─────────────────────────────────────────────────────────┐
│  Layer 1: Permission Allow/Deny（予防的制御）           │
│  → 危険な操作を事前にブロック                           │
├─────────────────────────────────────────────────────────┤
│  Layer 2: Hooks（検知・記録）                           │
│  → 機密操作を監査ログに記録                             │
├─────────────────────────────────────────────────────────┤
│  Layer 3: /security-review（能動的レビュー）            │
│  → コミット前のセキュリティチェック                      │
├─────────────────────────────────────────────────────────┤
│  Layer 4: ドキュメント・教育（意識づけ）                 │
│  → CLAUDE.md、ガイドラインによる行動規範                 │
└─────────────────────────────────────────────────────────┘
```

### 原則

| 原則 | 説明 |
|------|------|
| **最小権限** | 必要な操作のみ許可、デフォルトは制限的に |
| **透明性** | 何がブロックされ、何がログされるか明示 |
| **段階的対応** | 軽微な問題は警告、重大な問題はブロック |
| **カスタマイズ可能** | チーム・プロジェクトの要件に合わせて調整可能 |

---

## 2. パーミッション制御

### 2.1 現在の設定（settings.json）

#### 許可リスト（Allow）

```json
{
  "permissions": {
    "allow": [
      "Read",
      "Write",
      "Bash(git *)",
      "Bash(npm run *)",
      "Bash(npx *)",
      "Bash(node *)",
      "Bash(python *)",
      "Bash(pip *)",
      "Bash(cat *)",
      "Bash(ls *)",
      "Bash(grep *)",
      "Bash(find *)",
      "Bash(head *)",
      "Bash(tail *)",
      "Bash(wc *)",
      "Bash(mkdir *)",
      "Bash(cp *)",
      "Bash(mv *)",
      "Bash(pwd)",
      "Bash(which *)",
      "Bash(echo *)"
    ]
  }
}
```

#### 拒否リスト（Deny）

| カテゴリ | ルール | 理由 |
|---------|--------|------|
| **機密ファイル読み取り** | `Read(./.env)` | 環境変数に含まれる認証情報保護 |
| | `Read(./.env.*)` | 環境別設定ファイル保護 |
| | `Read(**/secrets/**)` | シークレットディレクトリ保護 |
| | `Read(**/.ssh/**)` | SSH鍵保護 |
| | `Read(**/*.pem)` | 証明書・秘密鍵保護 |
| | `Read(**/*secret*)` | シークレット関連ファイル保護 |
| | `Read(**/.aws/*)` | AWS認証情報保護 |
| **本番環境書き込み** | `Write(./production.*)` | 本番設定の誤変更防止 |
| | `Write(./.env.production)` | 本番環境変数の誤変更防止 |
| **危険コマンド** | `Bash(rm -rf /)` | システム破壊防止 |
| | `Bash(sudo *)` | 権限昇格防止 |
| | `Bash(chmod 777 *)` | 過剰な権限付与防止 |
| **リモート実行** | `Bash(curl * \| bash)` | 外部スクリプト実行防止 |
| | `Bash(curl * \| sh)` | 同上 |
| | `Bash(wget * \| bash)` | 同上 |
| | `Bash(wget * \| sh)` | 同上 |
| **デバイス操作** | `Bash(* > /dev/sd*)` | ディスク破壊防止 |
| | `Bash(dd if=*)` | 低レベルディスク操作防止 |

### 2.2 カスタマイズ例

#### より厳格な設定（金融・医療向け）

```json
{
  "permissions": {
    "deny": [
      "Read(**/*.key)",
      "Read(**/*.cert)",
      "Read(**/credentials/**)",
      "Write(**/*.sql)",
      "Bash(curl *)",
      "Bash(wget *)",
      "Bash(nc *)",
      "Bash(telnet *)"
    ]
  }
}
```

#### より緩和な設定（開発・実験向け）

```json
{
  "permissions": {
    "allow": [
      "Read(./.env.development)",
      "Read(./.env.test)"
    ]
  }
}
```

---

## 3. 監査ログ

### 3.1 現在の設定

以下の操作が `~/.claude/security-audit.log` に記録されます：

| トリガー | 記録内容 |
|---------|---------|
| `Write(*.env*)` | 環境変数ファイルへの書き込み |
| `Write(*secret*)` | シークレット関連ファイルへの書き込み |
| `Bash(git push*)` | リモートへのプッシュ |

### 3.2 ログフォーマット

```
2025-12-03_14:30:45|WRITE|.env.local
2025-12-03_15:22:10|GIT_PUSH
2025-12-03_16:45:33|WRITE|config/secrets.json
```

### 3.3 追加を検討すべき監査対象

| 操作 | 優先度 | 理由 |
|------|--------|------|
| `Bash(npm publish*)` | 高 | パッケージ公開は重大なアクション |
| `Bash(docker push*)` | 高 | イメージ公開 |
| `Write(*.sql)` | 中 | データベース変更 |
| `Bash(git force-push*)` | 中 | 履歴改変 |
| `Edit(**/*config*)` | 低 | 設定変更の追跡 |

### 3.4 ログ運用

```bash
# ログ確認
cat ~/.claude/security-audit.log

# 直近の操作確認
tail -20 ~/.claude/security-audit.log

# 特定操作の検索
grep "GIT_PUSH" ~/.claude/security-audit.log

# ログローテーション（手動）
mv ~/.claude/security-audit.log ~/.claude/security-audit.log.$(date +%Y%m%d)
```

---

## 4. セキュリティレビューコマンド

### 4.1 概要

`/security-review` コマンドは、コミット前にセキュリティ観点でのレビューを実施します。

### 4.2 検出対象

#### シークレット検出

| 種類 | 検出パターン |
|------|-------------|
| APIキー | `api[_-]?key`, `apikey` |
| パスワード | `password`, `passwd`, `pwd` |
| トークン | `token`, `bearer`, `auth` |
| 秘密鍵 | `-----BEGIN ... PRIVATE KEY-----` |
| AWS認証情報 | `aws_access_key`, `aws_secret`, `AKIA...` |
| 汎用シークレット | `secret`, `credential`, `private` |

#### セキュリティチェックリスト

1. **入力バリデーション**
   - ユーザー入力の検証
   - 型チェック
   - 長さ制限
   - 特殊文字のエスケープ

2. **認証・認可**
   - 保護ルートの認証要求
   - リソースアクセスの認可チェック
   - セッション/トークン管理
   - パスワードのハッシュ化

3. **インジェクション防止**
   - SQLパラメータ化
   - XSS対策
   - コマンドインジェクション対策
   - パストラバーサル対策

4. **データ保護**
   - 機密データのログ出力防止
   - エラーメッセージの情報漏洩防止
   - PII取り扱い
   - 暗号化

5. **依存関係**
   - 脆弱な依存関係の検出
   - 信頼できるソースからの取得
   - ロックファイルの更新

### 4.3 判定基準

| 判定 | 条件 | アクション |
|------|------|-----------|
| **PASS** | 問題なし | コミット可能 |
| **WARN** | 軽微な問題あり | 確認後コミット可 |
| **FAIL** | 重大な問題あり | 修正必須 |

---

## 5. 今後の拡張案

### 5.1 サンドボックスプロファイル（GitHub Issue #6）

作業内容に応じてセキュリティレベルを切り替える仕組み。

| プロファイル | 用途 | 特徴 |
|-------------|------|------|
| **strict** | 本番作業、機密データ | 確認多め、制限厳しい |
| **standard** | 通常開発 | バランス型（デフォルト） |
| **permissive** | 実験、プロトタイプ | 制限緩め |

```bash
# 切り替え例
cp ~/.claude/profiles/strict.json ~/.claude/settings.json
```

### 5.2 領域別セキュリティガイド（GitHub Issue #5）

開発領域ごとのセキュリティ注意点をSkillsとして提供。

- **Backend**: SQL インジェクション、認証実装、API設計
- **Frontend**: XSS、CSRF、機密データの露出
- **Infrastructure**: 権限設定、ネットワークセキュリティ

### 5.3 外部ツール連携

| ツール | 用途 | 連携方法 |
|--------|------|---------|
| `gitleaks` | シークレット検出 | pre-commit hook |
| `npm audit` | Node.js脆弱性 | CI/CD統合 |
| `pip-audit` | Python脆弱性 | CI/CD統合 |
| `trivy` | コンテナスキャン | CI/CD統合 |
| `SAST tools` | 静的解析 | CI/CD統合 |

---

## 6. 議論ポイント

チームで検討すべき項目をまとめました。

### 6.1 パーミッション設定

| 論点 | 選択肢 | 考慮事項 |
|------|--------|---------|
| `.env` ファイルの扱い | 完全拒否 / 開発用のみ許可 | 開発効率 vs セキュリティ |
| `sudo` の扱い | 完全拒否 / 特定コマンドのみ許可 | Docker等での必要性 |
| 外部通信 | curl/wget拒否 / 特定ドメインのみ | パッケージ取得の必要性 |

### 6.2 監査ログ

| 論点 | 選択肢 | 考慮事項 |
|------|--------|---------|
| ログ保存期間 | 7日 / 30日 / 無期限 | ストレージ vs 追跡可能性 |
| ログ対象範囲 | 機密操作のみ / 全操作 | パフォーマンス vs 網羅性 |
| ログ形式 | テキスト / JSON | 可読性 vs 解析容易性 |

### 6.3 レビュープロセス

| 論点 | 選択肢 | 考慮事項 |
|------|--------|---------|
| `/security-review` 実行タイミング | 任意 / コミット前必須 | 開発速度 vs 品質 |
| FAIL時の強制力 | 警告のみ / コミットブロック | 自律性 vs 強制力 |
| 外部ツール連携 | オプション / 必須 | 環境依存 vs 品質 |

### 6.4 組織・チーム固有の要件

以下の項目についてチームで確認してください：

- [ ] コンプライアンス要件（GDPR、HIPAA、PCI-DSS等）
- [ ] 社内セキュリティポリシーとの整合性
- [ ] インシデント発生時の対応フロー
- [ ] 監査対応の必要性
- [ ] 外部セキュリティ監査の要件

---

## 付録: 設定ファイル一覧

| ファイル | 場所 | 説明 |
|---------|------|------|
| `settings.json` | `~/.claude/settings.json` | パーミッション・Hooks設定 |
| `security-review.md` | `~/.claude/commands/security-review.md` | セキュリティレビューコマンド |
| `security-audit.log` | `~/.claude/security-audit.log` | 監査ログ（自動作成） |

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-03 | 初版作成（Phase 1 Core機能に基づく） |

---

*このドキュメントは議論用の叩き台です。チームの要件に合わせてカスタマイズしてください。*
